---
- name: Gather configuration information from Cisco IOS-XE devices
  hosts: cisco
  gather_facts: false
  become: false
  vars:
    backup_server: backup-server
  
  tasks:
    - name: Test for basic connection and login to Cisco device
      ansible.builtin.ping:

    - name: Test for basic connection and login to backup server
      delegate_to: "{{ backup_server }}"
      run_once: true
      ansible.builtin.ping:


    - name: Test to see if we can write to the EE (important for ios_config backup)
      delegate_to: localhost
      run_once: true
      block:
        - name: Copy structured network data to EE - Test to see if we can write to the EE
          ansible.builtin.copy:
            content: "Ansible Built This"
            dest: "/tmp/ansible_content.txt"
            mode: "644"

        - name: Test to see if the file exists on the EE
          ansible.builtin.command: "cat /tmp/ansible_content.txt"
    ### End block ###

    - name: Test to see if we can write to the RHEL host (backup server)
      delegate_to: "{{ backup_server }}"
      become: true
      run_once: true
      block:
        - name: Create a directory if it does not exist
          ansible.builtin.file:
            path: /backup/
            state: directory
            mode: "755"

        - name: Copy structured network data to host
          ansible.builtin.copy:
            content: "Ansible Built This"
            dest: "/backup/ansible_content.txt"
            mode: "644"

        - name: Test to see if the file exists on the RHEL host
          ansible.builtin.command: "cat /backup/ansible_content.txt"
    ### End block ###

    - name: Test to see if we can do a basic fact gathering from Cisco device
      block:
        - name: Gather network information as structured data - test to validate we can use ios_facts on cisco host
          cisco.ios.ios_facts:
            gather_network_resources:
              - 'all'

        - name: Print out
          ansible.builtin.debug:
            msg: "{{ ansible_network_resources | to_nice_yaml }}"
      ### End block ###

    - name: Test ability to use ios_command
      block:
        - name: Most basic command
          vars:
            ansible_command_timeout: 120
          cisco.ios.ios_command:
            commands:
              - command: 'sho run'

        - name: Copy running config to startup config
          vars:
            ansible_command_timeout: 120
          cisco.ios.ios_command:
            commands:
              - command: 'copy running-config startup-config'
                prompt: Destination
                answer: "\r"
      ### End block ###

    - name: Test ability to use ios_config
      block:
        - name: Backup cisco ios configuration
          vars:
            ansible_command_timeout: 120
          cisco.ios.ios_config:
            backup: true
            backup_options:
              dir_path: /tmp/
              filename: "{{ inventory_hostname }}.txt"
          register: config_output

        - name: Print out config
          ansible.builtin.command: "cat /tmp/{{ inventory_hostname }}.txt"
      ### End block ###

    - name: Finish Test if everything else works
      block:
        # This task removes the Current configuration... from the top of IOS routers show run
        - name: Remove non config lines - regexp
          ansible.builtin.lineinfile:
            path: "{{ config_output.backup_path }}"
            line: "Building configuration..."
            state: absent
          delegate_to: localhost

        - name: Create time stamp for play
          ansible.builtin.set_fact:
            datetime: "{{ lookup('pipe', 'date +%Y-%m-%d-%H-%M') }}"
          delegate_to: "{{ backup_server }}"
          delegate_facts: true
          run_once: true

        - name: Create a directory if it does not exist
          ansible.builtin.file:
            path: /backup/
            state: directory
            mode: "755"
          delegate_to: "{{ backup_server }}"
          become: true
          run_once: true

        - name: Save configuration to backup server
          ansible.builtin.copy:
            src: "{{ config_output.backup_path }}"
            dest: "/backup/{{ hostvars['backup-server'].datetime }}/"
            mode: "644"
          when: config_output is defined
          become: true
          delegate_to: "{{ backup_server }}"



