---
- name: Playbook to stage/scp .bin to router bootflash
  hosts: rtr1 
  gather_facts: False
  vars:
   new_version: "{{ image_staging }}" 
   #17.06.06a
   #17.07.01a
   new_image_ios: "c8000v-universalk9.{{ new_version }}.SPA.bin" 
   ansible_network_cli_ssh_type: paramiko

  tasks:

  - name: enable scp
    cisco.ios.ios_config:
      lines: 
      - ip scp server enable
      - ip ssh window-size 131072 
     
  - name: check if image already exist in bootflash
    ios_command:
      commands: 'dir bootflash: | include {{ new_image_ios }}'
    register: check_image
  
  - name: Push new image from project to bootflash
    vars:
      ansible_command_timeout: 1200
    ansible.netcommon.net_put:
      src: '{{ new_image_ios }}'
      dest: flash:{{new_image_ios }}
    register: cisco_changed
    when: 
    - check_image.stdout[0].find( new_image_ios )  == -1
    - inventory_hostname in groups['cisco']
  
 